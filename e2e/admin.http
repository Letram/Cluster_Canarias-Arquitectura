# E2E tests for Admin endpoints (VS Code REST Client)

###############################################################################
# ADMIN ENDPOINTS - Flight Cancellation Management
###############################################################################
#
# ENDPOINT: POST /admin/cancel-flights
# PURPOSE: Manually trigger automatic cancellation of flights with insufficient passengers
#
# CANCELLATION LOGIC:
# - Checks all SCHEDULED flights departing within 7 days
# - Cancels flights that haven't reached minimum passengers (5)
# - Processes refunds for all bookings on cancelled flights
# - Sends cancellation notifications to all passengers
#
# CONSOLE OUTPUT TO VERIFY:
#   [CANCELLATION SERVICE] Cancelling flight {id} - Only {count}/5 passengers, departing in {days} days
#   [PAYMENT GATEWAY] Processing refund for transaction {txn}: ${amount}
#   [PAYMENT GATEWAY] Refund successful for transaction {txn}
#   [NOTIFICATION SERVICE] Flight {id} CANCELLED - Notifying {count} passenger(s)
#   [NOTIFICATION SERVICE] Sending cancellation email to {passenger} (Booking: {id}, Refund: ${amount})
#   [CANCELLATION SERVICE] Cancelled {count} flight(s)
#
###############################################################################

###############################################################################
# SETUP - Create test scenario for cancellation
###############################################################################

### Step 1: Create a flight departing in 6 days (within cancellation window)
# Expected: 201 Created
POST http://localhost:8080/flights
Content-Type: application/json

{
  "rocketId": "00000000-0000-0000-0000-000000000001",
  "departureDate": "{{$datetime iso8601 6 d}}",
  "basePrice": 5000.0
}

### Step 2: Create only 3 bookings (below minimum of 5)
# Expected: 201 Created for each
# Note: Replace {flightId} with the ID from Step 1 response

POST http://localhost:8080/bookings
Content-Type: application/json

{
  "flightId": "{flightId}",
  "passengerName": "Passenger 1"
}

###

POST http://localhost:8080/bookings
Content-Type: application/json

{
  "flightId": "{flightId}",
  "passengerName": "Passenger 2"
}

###

POST http://localhost:8080/bookings
Content-Type: application/json

{
  "flightId": "{flightId}",
  "passengerName": "Passenger 3"
}

### Step 3: Verify flight is still SCHEDULED
# Expected: 200 OK, flight status should be SCHEDULED
GET http://localhost:8080/flights
Accept: application/json

###############################################################################
# CANCELLATION TESTS
###############################################################################

### Test 1: Trigger cancellation check
# Expected: 200 OK
# Response: { "message": "Flight cancellation check completed", "cancelledFlights": 1 }
# Console: Should show refund processing and notifications for 3 passengers
POST http://localhost:8080/admin/cancel-flights
Content-Type: application/json

### Test 2: Verify flight status changed to CANCELLED
# Expected: 200 OK, flight status should be CANCELLED
GET http://localhost:8080/flights
Accept: application/json

### Test 3: Verify bookings still exist (but flight is cancelled)
# Expected: 200 OK, should return 3 bookings
# Note: Replace {flightId} with the actual flight ID
GET http://localhost:8080/bookings?flightId={flightId}
Accept: application/json

### Test 4: Try to create new booking on cancelled flight
# Expected: 400 Bad Request - "Cannot book this flight. Status is CANCELLED"
# Note: Replace {flightId} with the actual flight ID
POST http://localhost:8080/bookings
Content-Type: application/json

{
  "flightId": "{flightId}",
  "passengerName": "Late Passenger"
}

### Test 5: Run cancellation check again (no flights to cancel)
# Expected: 200 OK
# Response: { "message": "Flight cancellation check completed", "cancelledFlights": 0 }
POST http://localhost:8080/admin/cancel-flights
Content-Type: application/json

###############################################################################
# EDGE CASES
###############################################################################

### Edge Case 1: Flight with exactly 5 passengers (minimum) should NOT be cancelled
# Setup: Create flight and 5 bookings

POST http://localhost:8080/flights
Content-Type: application/json

{
  "rocketId": "00000000-0000-0000-0000-000000000001",
  "departureDate": "{{$datetime iso8601 6 d}}",
  "basePrice": 4000.0
}

### Create 5 bookings (replace {flightId2} with new flight ID)
# ... (repeat POST /bookings 5 times)

### Then trigger cancellation
# Expected: This flight should NOT be cancelled (has minimum passengers)
POST http://localhost:8080/admin/cancel-flights
Content-Type: application/json

### Edge Case 2: Flight departing in 8 days should NOT be cancelled
# (Outside the 7-day cancellation window)

POST http://localhost:8080/flights
Content-Type: application/json

{
  "rocketId": "00000000-0000-0000-0000-000000000001",
  "departureDate": "{{$datetime iso8601 8 d}}",
  "basePrice": 4000.0
}

### Create only 2 bookings (replace {flightId3} with new flight ID)

POST http://localhost:8080/bookings
Content-Type: application/json

{
  "flightId": "{flightId3}",
  "passengerName": "Early Passenger 1"
}

###

POST http://localhost:8080/bookings
Content-Type: application/json

{
  "flightId": "{flightId3}",
  "passengerName": "Early Passenger 2"
}

### Trigger cancellation
# Expected: This flight should NOT be cancelled (outside 7-day window)
POST http://localhost:8080/admin/cancel-flights
Content-Type: application/json

### Edge Case 3: CONFIRMED flight should NOT be cancelled
# (Even if within 7 days, confirmed flights are not cancelled)
# Note: CONFIRMED flights have already reached minimum passengers

###############################################################################
# COMPLETE TEST SCENARIO
###############################################################################

### Scenario: Multiple flights with different conditions
# 1. Flight A: 6 days away, 3 passengers → SHOULD BE CANCELLED
# 2. Flight B: 6 days away, 5 passengers → SHOULD NOT BE CANCELLED
# 3. Flight C: 8 days away, 2 passengers → SHOULD NOT BE CANCELLED (too far)
# 4. Flight D: 5 days away, 0 passengers → SHOULD BE CANCELLED

# After running cancellation check:
# Expected: { "cancelledFlights": 2 } (Flight A and Flight D)

###############################################################################
# NOTES
###############################################################################
#
# MANUAL TESTING STEPS:
# 1. Start the server: java -jar target/astrobookings-legacy-1.0-SNAPSHOT.jar
# 2. Create test flights with different scenarios
# 3. Run POST /admin/cancel-flights
# 4. Check server console for detailed logs
# 5. Verify flight statuses changed to CANCELLED
# 6. Verify refunds were processed (check console logs)
# 7. Verify notifications were sent (check console logs)
#
# AUTOMATED TESTING:
# This endpoint is designed for manual/scheduled execution
# In production, this could be triggered by:
# - Cron job
# - Scheduled task
# - Admin dashboard button
# - Background worker
#
###############################################################################
